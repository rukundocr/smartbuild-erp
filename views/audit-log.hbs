<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <div>
        <h2 class="fw-bold text-white mb-1">System Audit Log</h2>
        <p class="text-secondary mb-0 x-small uppercase tracking-wider">Security & Activity Tracking</p>
    </div>
    <div class="d-flex gap-2">
        <span class="badge bg-dark border border-secondary text-secondary py-2 px-3">
            <i class="fas fa-shield-alt me-1 text-info"></i> ACTIVE MONITORING
        </span>
    </div>
</div>

<div class="card p-3 border-secondary bg-dark mb-4 shadow-sm">
    <form action="/audit" method="GET">
        <div class="row g-2 align-items-end">
            <div class="col-6 col-md-2">
                <label class="small text-secondary mb-1">From Date</label>
                <input type="date" name="startDate" class="form-control form-control-sm bg-black border-secondary text-white" value="{{startDate}}">
            </div>
            <div class="col-6 col-md-2">
                <label class="small text-secondary mb-1">To Date</label>
                <input type="date" name="endDate" class="form-control form-control-sm bg-black border-secondary text-white" value="{{endDate}}">
            </div>

            <div class="col-6 col-md-2">
                <label class="small text-secondary mb-1">Module</label>
                <select name="module" class="form-select form-select-sm bg-black border-secondary text-white">
                    <option value="">All Modules</option>
                    {{#each modules}}
                        <option value="{{this}}" {{#if (eq ../selectedModule this)}}selected{{/if}}>{{this}}</option>
                    {{/each}}
                </select>
            </div>

            <div class="col-6 col-md-2">
                <label class="small text-secondary mb-1">Action</label>
                <select name="action" class="form-select form-select-sm bg-black border-secondary text-white">
                    <option value="">All Actions</option>
                    {{#each actions}}
                        <option value="{{this}}" {{#if (eq ../selectedAction this)}}selected{{/if}}>{{this}}</option>
                    {{/each}}
                </select>
            </div>

            <div class="col-6 col-md-2">
                <label class="small text-secondary mb-1">Performed By</label>
                <select name="userId" class="form-select form-select-sm bg-black border-secondary text-white">
                    <option value="">All Users</option>
                    {{#each users}}
                        <option value="{{this._id}}" {{#if (eq ../selectedUser (toString this._id))}}selected{{/if}}>{{this.name}}</option>
                    {{/each}}
                </select>
            </div>

            <div class="col-12 col-md-2 d-flex gap-1">
                <button type="submit" class="btn btn-sm btn-primary flex-grow-1 fw-bold">FILTER</button>
                <a href="/audit" class="btn btn-sm btn-outline-secondary flex-grow-1 fw-bold">RESET</a>
            </div>
        </div>
    </form>
</div>

<div class="text-end mb-3">
    <form action="/audit/clear" method="POST" onsubmit="return confirm('CRITICAL: Permanently delete all logs?')">
        <button type="submit" class="btn btn-xs btn-outline-danger small fw-bold px-3">
            <i class="fas fa-trash-alt me-1"></i> CLEAR ALL SYSTEM LOGS
        </button>
    </form>
</div>

<div class="card border-secondary bg-dark shadow-lg overflow-hidden">
    <div class="table-responsive">
        <table class="table table-dark table-hover mb-0">
            <thead class="bg-secondary text-white">
                <tr class="small border-bottom border-secondary">
                    <th class="py-3 px-3">TIMESTAMP</th>
                    <th class="py-3">USER</th>
                    <th class="py-3">ACTION</th>
                    <th class="py-3">MODULE</th>
                    <th class="py-3 px-3">DETAILS</th>
                </tr>
            </thead>
            <tbody class="bg-dark">
                {{#each logs}}
                <tr class="align-middle border-bottom border-secondary">
                    <td class="small text-white-50 px-3">{{formatDate this.timestamp}}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-info text-dark rounded-circle d-flex align-items-center justify-content-center me-2 fw-bold" style="width: 28px; height: 28px; font-size: 0.65rem;">
                                {{#if this.createdBy.name}}{{substring this.createdBy.name 0 1}}{{else}}S{{/if}}
                            </div>
                            <span class="text-white small">{{#if this.createdBy.name}}{{this.createdBy.name}}{{else}}System{{/if}}</span>
                        </div>
                    </td>
                    <td>
                        <span class="badge {{#if (eq this.action 'DELETE')}}bg-danger{{else if (eq this.action 'UPDATE')}}bg-warning text-dark{{else if (eq this.action 'CREATE')}}bg-success{{else}}bg-info{{/if}} x-small fw-bold">
                            {{this.action}}
                        </span>
                    </td>
                    <td class="text-info x-small fw-bold">{{this.module}}</td>
                    <td class="text-white-50 small px-3" style="max-width: 400px; white-space: normal;">
                        {{this.details}}
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <i class="fas fa-history fa-2x text-secondary mb-3"></i>
                        <p class="text-secondary">No activity logs found for the selected filters.</p>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

{{#if pagination.totalPages}}
<div class="d-flex justify-content-between align-items-center mt-4 mb-5">
    <span class="small text-secondary">Page {{pagination.currentPage}} of {{pagination.totalPages}}</span>
    <nav>
        <ul class="pagination pagination-sm mb-0">
            {{#if pagination.hasPrev}}
            <li class="page-item">
                <a class="page-link bg-dark border-secondary text-white" href="/audit?page={{pagination.prevPage}}{{#if startDate}}&startDate={{startDate}}{{/if}}{{#if endDate}}&endDate={{endDate}}{{/if}}{{#if selectedModule}}&module={{selectedModule}}{{/if}}{{#if selectedAction}}&action={{selectedAction}}{{/if}}{{#if selectedUser}}&userId={{selectedUser}}{{/if}}">Prev</a>
            </li>
            {{/if}}
            
            <li class="page-item active"><span class="page-link bg-primary border-primary">{{pagination.currentPage}}</span></li>
            
            {{#if pagination.hasNext}}
            <li class="page-item">
                <a class="page-link bg-dark border-secondary text-white" href="/audit?page={{pagination.nextPage}}{{#if startDate}}&startDate={{startDate}}{{/if}}{{#if endDate}}&endDate={{endDate}}{{/if}}{{#if selectedModule}}&module={{selectedModule}}{{/if}}{{#if selectedAction}}&action={{selectedAction}}{{/if}}{{#if selectedUser}}&userId={{selectedUser}}{{/if}}">Next</a>
            </li>
            {{/if}}
        </ul>
    </nav>
</div>
{{/if}}