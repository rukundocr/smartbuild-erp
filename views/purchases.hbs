<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <div>
        <h2 class="fw-bold text-white mb-1">EBM PURCHASES DATA FROM RRA</h2>
        <p class="text-secondary mb-0">Total VAT Input: <span class="text-info fw-bold">{{formatCurrency
                totals.vat}}</span></p>
    </div>
    <div class="d-flex gap-2">
        {{!-- Updated Export Link to include TIN filter --}}
        <a href="/purchases/export?startDate={{startDate}}&endDate={{endDate}}&supplierTIN={{supplierTIN}}"
            class="btn btn-outline-light btn-sm fw-bold shadow-sm">
            <i class="fas fa-file-csv me-1"></i> EXPORT CSV
        </a>
        <button class="btn btn-primary btn-sm fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-file-import me-1"></i> IMPORT RRA CSV
        </button>
    </div>
</div>

{{!-- ⚠️ Cancelled Invoice Warning Card (Inline) --}}
{{#if cancelledInvoices}}
<div class="alert alert-danger alert-dismissible fade show border-0 shadow-lg mb-4" role="alert"
    style="background: #1a0a0a; border-left: 5px solid #dc3545 !important;">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-3">
            <div
                style="width:42px;height:42px;background:rgba(220,53,69,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <i class="fas fa-exclamation-triangle text-danger fs-5"></i>
            </div>
            <div>
                <h5 class="alert-heading fw-bold text-white mb-0">⚠️ CANCELLED INVOICE ALERT</h5>
                <p class="text-secondary small mb-0">{{cancelledInvoices.length}} invoice(s) found in system but MISSING
                    from the new CSV — auto-deleted</p>
            </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="alert d-flex gap-2 mb-3"
        style="background:rgba(220,53,69,0.08);border:1px solid rgba(220,53,69,0.2);border-radius:8px;">
        <i class="fas fa-info-circle text-danger mt-1 flex-shrink-0"></i>
        <span class="small text-secondary">These invoices existed in your records but were <strong
                class="text-danger">not present</strong> in the new RRA CSV upload — likely cancelled by the supplier.
            They have been <strong class="text-warning">deleted</strong> and a full audit log entry has been
            saved.</span>
    </div>

    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
        <table class="table table-sm table-dark table-hover mb-0" style="font-size: 0.85rem;">
            <thead>
                <tr style="border-bottom:1px solid #dc3545;color:#dc3545;text-transform:uppercase;font-size:0.7rem;">
                    <th class="py-2">Receipt #</th>
                    <th>Supplier</th>
                    <th>Date</th>
                    <th class="text-end px-3">Total (RWF)</th>
                </tr>
            </thead>
            <tbody>
                {{#each cancelledInvoices}}
                <tr style="border-bottom:1px solid #222;">
                    <td class="font-monospace text-warning py-2">{{this.receiptNumber}}</td>
                    <td class="text-white">{{this.supplierName}}</td>
                    <td class="text-secondary">{{this.date}}</td>
                    <td class="text-end fw-bold text-danger px-3">{{this.totalAmount}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    <div class="mt-3 d-flex justify-content-between align-items-center">
        <p class="text-secondary x-small mb-0">
            <i class="fas fa-shield-alt me-1 text-success"></i>All records are fully logged in the system Audit Log
        </p>
        <button type="button" class="btn btn-sm btn-outline-danger fw-bold" data-bs-dismiss="alert">
            <i class="fas fa-check me-1"></i> DISMISS WARNING
        </button>
    </div>
</div>
{{/if}}

<div class="card p-3 border-secondary bg-dark mb-4 shadow-sm">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-9">
            <form action="/purchases" method="GET" class="row g-2 align-items-end">
                <div class="col-6 col-md-3">
                    <label class="small text-secondary mb-1">From Date</label>
                    <input type="date" name="startDate" class="form-control bg-black border-secondary text-white"
                        value="{{startDate}}">
                </div>
                <div class="col-6 col-md-3">
                    <label class="small text-secondary mb-1">To Date</label>
                    <input type="date" name="endDate" class="form-control bg-black border-secondary text-white"
                        value="{{endDate}}">
                </div>
                {{!-- NEW: Supplier TIN Filter --}}
                <div class="col-12 col-md-3">
                    <label class="small text-secondary mb-1">Supplier TIN</label>
                    <input type="text" name="supplierTIN" class="form-control bg-black border-secondary text-white"
                        placeholder="Search TIN..." value="{{supplierTIN}}">
                </div>
                <div class="col-12 col-md-3 d-flex gap-1">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">FILTER</button>
                    <a href="/purchases" class="btn btn-outline-secondary w-100 fw-bold">RESET</a>
                </div>
            </form>
        </div>

        <div class="col-12 col-md-3">
            <form action="/purchases/delete-all" method="POST"
                onsubmit="return confirm('CRITICAL: This will permanently delete ALL imported RRA records. Are you sure you want to proceed?')">
                <button type="submit" class="btn btn-sm btn-outline-danger fw-bold py-2 w-100">
                    <i class="fas fa-trash-alt me-1"></i> CLEAR ALL DATA
                </button>
            </form>
        </div>
    </div>
</div>
<div class="row g-2 mb-4">
    <div class="col-6 col-md-2">
        <div class="card bg-black border-primary py-2 px-3 shadow-sm h-100">
            <div class="text-center">
                <span class="text-primary small text-uppercase fw-semibold" style="font-size: 0.6rem;">All
                    Imports</span>
                <span class="d-block text-white fw-bold h6 mb-0">{{totalImportedAllTime}}</span>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card bg-dark border-secondary py-2 px-3 shadow-sm border-warning h-100">
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-warning small text-uppercase fw-semibold" style="font-size: 0.65rem;">Net
                    Purchases</span>
                <span class="text-warning fw-bold h6 mb-0">{{formatCurrency totals.net}}</span>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card bg-dark border-secondary py-2 px-3 shadow-sm border-info h-100">
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-info small text-uppercase fw-semibold" style="font-size: 0.65rem;">VAT COLLECTED
                    (18%)</span>
                <span class="text-info fw-bold h6 mb-0">{{formatCurrency totals.vat}}</span>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card bg-dark border-secondary py-2 px-3 shadow-sm border-success h-100">
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-success small text-uppercase fw-semibold" style="font-size: 0.65rem;">Total PURCHASES
                </span>
                <span class="text-success fw-bold h6 mb-0">{{formatCurrency totals.total}}</span>
            </div>
        </div>
    </div>
</div>
{{!-- Table Search Field --}}
<div class="row mb-3">
    <div class="col-12 col-md-4 ms-auto">
        <div class="input-group input-group-sm">
            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fas fa-search"></i></span>
            <input type="text" id="customSearchInput" class="form-control bg-dark border-secondary text-white"
                placeholder="Search in table...">
        </div>
    </div>
</div>

{{!-- Mobile View --}}
<div class="d-block d-md-none">
    {{#each purchases}}
    <div class="card border-secondary bg-dark mb-3 shadow">
        <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
                <span class="badge bg-secondary">TIN: {{this.supplierTIN}}</span>
                <span class="text-secondary small">{{formatDate this.date}}</span>
            </div>
            <h6 class="text-white fw-bold mb-1">{{this.supplierName}}</h6>
            <p class="text-warning small font-monospace mb-2">Ref: {{this.receiptNumber}}</p>
            <div class="d-flex justify-content-between align-items-center border-top border-secondary pt-2">
                <div>
                    <div class="x-small text-secondary">VAT</div>
                    <div class="text-info small fw-bold">{{formatCurrency this.vat}}</div>
                </div>
                <div class="text-end">
                    <div class="x-small text-secondary">TOTAL</div>
                    <div class="text-success fw-bold">{{formatCurrency this.totalAmount}}</div>
                </div>
            </div>
        </div>
    </div>
    {{else}}
    <p class="text-center text-secondary py-4">No RRA records found for this criteria.</p>
    {{/each}}
</div>

{{!-- Desktop View --}}
<div class="card border-secondary bg-dark d-none d-md-block shadow">
    <div class="table-responsive p-3" style="max-height: 600px; overflow-y: auto;">
        <table id="purchasesTable" class="table table-dark table-hover mb-0 w-100">
            <thead class="sticky-top bg-dark">
                <tr class="text-secondary small border-bottom border-secondary">
                    <th class="py-3 px-3">DATE</th>
                    <th class="py-3">SUPPLIER</th>
                    <th class="py-3">TIN</th>
                    <th class="py-3">RECEIPT #</th>
                    <th class="py-3 text-end">NET</th>
                    <th class="py-3 text-end text-info">VAT</th>
                    <th class="py-3 text-end px-3">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                {{#each purchases}}
                <tr class="align-middle border-bottom border-secondary">
                    <td class="small text-secondary px-3">{{formatDate this.date}}</td>

                    <td class="fw-bold text-white">{{this.supplierName}}</td>
                    <td class="x-small text-white">{{this.supplierTIN}}</td>

                    <td class="font-monospace small text-warning">{{this.receiptNumber}}</td>
                    <td class="text-end">{{formatCurrency this.amountWithoutVAT}}</td>
                    <td class="text-end text-info">{{formatCurrency this.vat}}</td>
                    <td class="text-end fw-bold px-3 text-success">{{formatCurrency this.totalAmount}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>


{{!-- Import Modal --}}
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title fw-bold">Import RRA Purchase Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/purchases/import" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <p class="small text-secondary">Select the <strong>CSV</strong> file exported from the RRA system.
                    </p>
                    <input type="file" name="file" class="form-control bg-black border-secondary text-white"
                        accept=".csv" required>
                    <div class="mt-2 x-small text-muted">Note: Duplicate receipt numbers are automatically skipped.
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">START IMPORT</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{!-- ⚠️ Cancelled Invoice Warning Popup --}}
{{#if cancelledInvoices}}
<div class="modal fade" id="cancelledInvoicesModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0" style="background:#1a0a0a;border:2px solid #dc3545 !important;">
            <div class="modal-header border-0 pb-2" style="background:linear-gradient(135deg,#dc3545,#7b1818);">
                <div class="d-flex align-items-center gap-3">
                    <div
                        style="width:42px;height:42px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-exclamation-triangle text-white fs-5"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold text-white mb-0">⚠️ CANCELLED INVOICE ALERT</h5>
                        <p class="text-white opacity-75 small mb-0">{{cancelledInvoices.length}} invoice(s) were in your
                            system but MISSING from the new CSV — auto-deleted</p>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-3">
                <div class="alert d-flex gap-2 mb-3"
                    style="background:rgba(220,53,69,0.12);border:1px solid rgba(220,53,69,0.4);border-radius:8px;">
                    <i class="fas fa-info-circle text-danger mt-1 flex-shrink-0"></i>
                    <span class="small text-secondary">These invoices existed in your records but were <strong
                            class="text-danger">not present</strong> in the new RRA CSV upload — likely cancelled by the
                        supplier on the RRA system. Each has been <strong class="text-warning">auto-deleted</strong>
                        from the database and a full <strong class="text-info">audit log entry</strong> has been saved
                        with complete details.</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0" style="color:#ccc;">
                        <thead>
                            <tr
                                style="border-bottom:1px solid #dc3545;color:#dc3545;font-size:0.7rem;text-transform:uppercase;">
                                <th>Receipt #</th>
                                <th>Supplier</th>
                                <th>TIN</th>
                                <th>Goods</th>
                                <th>Date</th>
                                <th class="text-end">Net (RWF)</th>
                                <th class="text-end">VAT (RWF)</th>
                                <th class="text-end">Total (RWF)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each cancelledInvoices}}
                            <tr style="border-bottom:1px solid #2a0a0a;">
                                <td class="font-monospace text-warning small fw-bold">{{this.receiptNumber}}</td>
                                <td class="fw-semibold text-white">{{this.supplierName}}</td>
                                <td class="text-secondary small">{{this.supplierTIN}}</td>
                                <td class="text-secondary small">{{this.natureOfGoods}}</td>
                                <td class="text-secondary small">{{this.date}}</td>
                                <td class="text-end text-light">{{this.amountWithoutVAT}}</td>
                                <td class="text-end text-info">{{this.vat}}</td>
                                <td class="text-end fw-bold text-danger">{{this.totalAmount}}</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0" style="background:rgba(220,53,69,0.08);">
                <p class="text-secondary x-small me-auto mb-0">
                    <i class="fas fa-shield-alt me-1 text-success"></i>Full details saved to Audit Log
                </p>
                <button type="button" class="btn btn-danger fw-bold px-4" data-bs-dismiss="modal">
                    <i class="fas fa-check me-1"></i>I have read this warning
                </button>
            </div>
        </div>
    </div>
</div>
{{/if}}

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

<script>
    $(document).ready(function () {
        if ($.fn.DataTable.isDataTable('#purchasesTable')) {
            $('#purchasesTable').DataTable().destroy();
        }

        const table = $('#purchasesTable').DataTable({
            dom: 'Brtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    text: '<i class="fas fa-file-excel me-1"></i> DOWNLOAD EXCEL',
                    className: 'btn btn-success btn-sm mb-3 fw-bold me-2',
                    title: 'Purchases Report',
                    exportOptions: { columns: [0, 1, 2, 3, 4, 5, 6] }
                }
            ],
            order: [[0, 'desc']],
            pageLength: 25,
            responsive: true
        });

        // Custom search input connection
        $('#customSearchInput').on('keyup', function () {
            table.search(this.value).draw();
        });
    });
</script>