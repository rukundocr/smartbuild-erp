<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <div>
        <h2 class="fw-bold text-white mb-1">Loan Management</h2>
        <p class="text-secondary mb-0 x-small uppercase tracking-wider">Track Borrowings & Repayments (RWF)</p>
    </div>
    <div class="d-flex gap-2">
        <a href="/loans/export-pdf" class="btn btn-outline-danger fw-bold shadow-sm">
            <i class="fas fa-file-pdf me-1"></i> EXPORT PDF
        </a>
        <button class="btn btn-primary fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#newLoanModal">
            <i class="fas fa-plus-circle me-1"></i> REGISTER NEW LOAN
        </button>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card bg-dark border-secondary p-3 shadow-sm">
            <span class="text-secondary small uppercase fw-bold">Total Borrowed</span>
            <h3 class="text-white fw-bold mb-0 mt-1">{{formatCurrency totals.totalBorrowed}}</h3>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark border-secondary p-3 shadow-sm border-start border-4 border-success">
            <span class="text-success small uppercase fw-bold">Total Paid</span>
            <h3 class="text-white fw-bold mb-0 mt-1">{{formatCurrency totals.totalPaid}}</h3>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark border-secondary p-3 shadow-sm border-start border-4 border-warning">
            <span class="text-warning small uppercase fw-bold">Remaining Balance</span>
            <h3 class="text-white fw-bold mb-0 mt-1">{{formatCurrency totals.remaining}}</h3>
        </div>
    </div>
</div>

<div class="card bg-dark border-secondary shadow-lg overflow-hidden">
    <div class="table-responsive">
        <table class="table table-dark table-hover mb-0">
            <thead class="bg-secondary text-white">
                <tr class="small border-bottom border-secondary">
                    <th class="py-3 px-3">LENDER & DETAILS</th>
                    <th class="py-3 text-center">STATUS</th>
                    <th class="py-3" style="width: 200px;">REPAYMENT PROGRESS</th>
                    <th class="py-3 text-end px-3">ACTIONS</th>
                </tr>
            </thead>
            <tbody>
                {{#each loans}}
                <tr class="align-middle border-bottom border-secondary">
                    <td class="px-3">
                        <div class="fw-bold text-white fs-6">{{this.lenderName}}</div>
                        <div class="text-secondary x-small mb-1">{{this.description}}</div>
                        <div class="badge bg-black border border-secondary text-info x-small">
                            <i class="far fa-calendar-alt me-1"></i> {{formatDate this.dateBorrowed}}
                        </div>
                    </td>
                    <td class="text-center">
                        <span
                            class="badge {{#if (eq this.status 'Cleared')}}bg-success{{else}}bg-primary{{/if}} x-small fw-bold px-3">
                            {{this.status}}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex justify-content-between x-small mb-1 text-secondary">
                            <span>{{percentage this.amountPaid this.totalAmount}}%</span>
                            <span>{{subtract this.totalAmount this.amountPaid}} left</span>
                        </div>
                        <div class="progress bg-black border border-secondary"
                            style="height: 8px; border-radius: 10px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                style="width: {{percentage this.amountPaid this.totalAmount}}%"
                                aria-valuenow="{{this.amountPaid}}" aria-valuemin="0"
                                aria-valuemax="{{this.totalAmount}}">
                            </div>
                        </div>
                    </td>
                    <td class="text-end px-3">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-info fw-bold px-3" data-bs-toggle="modal"
                                data-bs-target="#payModal{{this._id}}">
                                PAY
                            </button>
                            <a href="/loans/history/{{this._id}}" class="btn btn-sm btn-outline-secondary fw-bold px-3">
                                HISTORY
                            </a>
                            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal"
                                data-bs-target="#editModal{{this._id}}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form action="/loans/delete/{{this._id}}" method="POST" class="d-inline"
                                onsubmit="return confirm('Permanently delete this loan record?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger border-start-0">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>

                <div class="modal fade" id="payModal{{this._id}}" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content bg-dark border-secondary text-white shadow-lg">
                            <form action="/loans/payment/{{this._id}}" method="POST">
                                <div class="modal-header border-secondary">
                                    <h5 class="modal-title fw-bold">Record Repayment</h5>
                                    <button type="button" class="btn-close btn-close-white"
                                        data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="text-secondary small">Lender: <span
                                            class="text-white">{{this.lenderName}}</span></p>
                                    <div class="mb-3">
                                        <label class="small text-secondary mb-1">Payment Amount (RWF)</label>
                                        <input type="number" name="amount"
                                            class="form-control bg-black border-secondary text-white" required min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label class="small text-secondary mb-1">Notes / Receipt Ref</label>
                                        <input type="text" name="note"
                                            class="form-control bg-black border-secondary text-white"
                                            placeholder="Cash, Check #, etc.">
                                    </div>
                                </div>
                                <div class="modal-footer border-secondary">
                                    <button type="submit" class="btn btn-success fw-bold w-100 py-2">CONFIRM
                                        PAYMENT</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
    </div>


    <div class="modal fade" id="editModal{{this._id}}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white shadow-lg">
                <form action="/loans/update/{{this._id}}" method="POST">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title fw-bold text-warning">Edit Loan Record</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="small text-secondary mb-1">Lender Name</label>
                            <input type="text" name="lenderName"
                                class="form-control bg-black border-secondary text-white" value="{{this.lenderName}}"
                                required>
                        </div>
                        <div class="row mb-3 g-2">
                            <div class="col-6">
                                <label class="small text-secondary mb-1">Total Loan Amount</label>
                                <input type="number" name="totalAmount"
                                    class="form-control bg-black border-secondary text-white"
                                    value="{{this.totalAmount}}" required>
                            </div>
                            <div class="col-6">
                                <label class="small text-secondary mb-1">Status</label>
                                <select name="status" class="form-select bg-black border-secondary text-white">
                                    <option value="Active" {{#if (eq this.status 'Active' )}}selected{{/if}}>Active
                                    </option>
                                    <option value="Cleared" {{#if (eq this.status 'Cleared' )}}selected{{/if}}>Cleared
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="small text-secondary mb-1">Description</label>
                            <textarea name="description" class="form-control bg-black border-secondary text-white"
                                rows="2">{{this.description}}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning fw-bold w-100 py-2 text-dark">SAVE
                            CHANGES</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {{else}}
    <tr>
        <td colspan="4" class="text-center py-5">
            <i class="fas fa-hand-holding-usd fa-3x text-secondary mb-3 opacity-25"></i>
            <p class="text-secondary mb-0">No active loans found in the system.</p>
        </td>
    </tr>
    {{/each}}
    </tbody>
    </table>
</div>
</div>

<div class="modal fade" id="newLoanModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary text-white shadow-lg">
            <form action="/loans/create" method="POST">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title fw-bold text-primary">New Loan Registration</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="small text-secondary mb-1">Lender / Source Name</label>
                        <input type="text" name="lenderName" class="form-control bg-black border-secondary text-white"
                            required placeholder="e.g. Bank of Kigali, Person Name">
                    </div>
                    <div class="row mb-3 g-2">
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">Principal Amount (RWF)</label>
                            <input type="number" name="totalAmount"
                                class="form-control bg-black border-secondary text-white" required>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-secondary mb-1">Date Borrowed</label>
                            <input type="date" name="dateBorrowed"
                                class="form-control bg-black border-secondary text-white" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-secondary mb-1">Loan Purpose / Details</label>
                        <textarea name="description" class="form-control bg-black border-secondary text-white" rows="2"
                            placeholder="e.g. Purchase of cement for Project X"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-primary fw-bold w-100 py-2">SAVE LOAN RECORD</button>
                </div>
            </form>
        </div>
    </div>
</div>